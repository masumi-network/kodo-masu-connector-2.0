{% extends "base.html" %}

{% block title %}Flows - Kodosumi Admin{% endblock %}

{% block header %}Flows Management{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" id="search-input" placeholder="Search flows...">
            <button class="btn btn-outline-secondary" type="button" onclick="searchFlows()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <span id="flow-count" class="text-muted">Loading...</span>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Summary</th>
                        <th>Author</th>
                        <th>Method</th>
                        <th>Agent ID</th>
                        <th>Tags</th>
                        <th>Status</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="flows-table">
                    <tr>
                        <td colspan="8" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <nav aria-label="Flows pagination">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be populated by JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Flow Schema Modal -->
<div class="modal fade" id="schemaModal" tabindex="-1" aria-labelledby="schemaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schemaModalLabel">Flow Input Schema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="schema-content" class="schema-viewer">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Flow Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Flow Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="details-content">
                <!-- Details will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentSearch = '';

async function loadFlows(page = 1, search = '') {
    try {
        const response = await fetch(`/api/flows?page=${page}&per_page=10&search=${encodeURIComponent(search)}`);
        const data = await response.json();
        
        const flowsTable = document.getElementById('flows-table');
        flowsTable.innerHTML = '';
        
        if (data.flows.length === 0) {
            flowsTable.innerHTML = '<tr><td colspan="8" class="text-center">No flows found</td></tr>';
            return;
        }
        
        data.flows.forEach(flow => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${flow.summary || 'Untitled'}</strong>
                    <br><small class="text-muted">${flow.description ? flow.description.substring(0, 100) + '...' : 'No description'}</small>
                </td>
                <td>${flow.author || 'Unknown'}</td>
                <td><span class="badge bg-info">${flow.method || 'N/A'}</span></td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control form-control-sm" id="agent-${flow.id}" 
                               value="${flow.agent_identifier || ''}" placeholder="Enter Agent ID">
                        <button class="btn btn-outline-success btn-sm" onclick="saveAgentId(${flow.id})">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </td>
                <td>
                    ${flow.tags ? flow.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : 'No tags'}
                </td>
                <td>
                    ${flow.deprecated ? '<span class="badge bg-warning">Deprecated</span>' : '<span class="badge bg-success">Active</span>'}
                </td>
                <td>${flow.updated_at ? new Date(flow.updated_at).toLocaleString() : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewSchema(${flow.id}, 'original')">
                        <i class="fas fa-code"></i> Original
                    </button>
                    <button class="btn btn-sm btn-success" onclick="viewSchema(${flow.id}, 'mip003')">
                        <i class="fas fa-cogs"></i> MIP003
                    </button>
                    <button class="btn btn-sm btn-info" onclick="viewDetails(${flow.id})">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                </td>
            `;
            flowsTable.appendChild(row);
        });
        
        // Update pagination
        updatePagination(data.page, data.pages);
        
        // Update flow count
        document.getElementById('flow-count').textContent = `Showing ${data.flows.length} of ${data.total} flows`;
        
    } catch (error) {
        console.error('Error loading flows:', error);
        document.getElementById('flows-table').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading flows</td></tr>';
    }
}

function updatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    loadFlows(page, currentSearch);
}

function searchFlows() {
    currentSearch = document.getElementById('search-input').value;
    currentPage = 1;
    loadFlows(1, currentSearch);
}

async function viewSchema(flowId, schemaType = 'original') {
    try {
        const response = await fetch(`/api/flows/${flowId}/schema`);
        const data = await response.json();
        
        const schemaContent = document.getElementById('schema-content');
        const modalTitle = document.getElementById('schemaModalLabel');
        
        if (data.error) {
            schemaContent.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
            modalTitle.textContent = 'Schema Error';
        } else {
            let schemaToShow;
            let title;
            
            if (schemaType === 'mip003') {
                schemaToShow = data.mip003_schema;
                title = 'MIP003 Schema';
                
                if (!schemaToShow) {
                    schemaContent.innerHTML = '<div class="alert alert-warning">MIP003 schema not available for this flow</div>';
                    modalTitle.textContent = title;
                    const modal = new bootstrap.Modal(document.getElementById('schemaModal'));
                    modal.show();
                    return;
                }
            } else {
                schemaToShow = data.original_schema;
                title = 'Original Kodosumi Schema';
            }
            
            modalTitle.textContent = title;
            
            if (schemaToShow) {
                schemaContent.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Schema Format: ${schemaType === 'mip003' ? 'MIP003' : 'Kodosumi'}</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copySchema(event)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre id="schema-json"><code>${JSON.stringify(schemaToShow, null, 2)}</code></pre>
                `;
            } else {
                schemaContent.innerHTML = '<div class="alert alert-warning">No schema available</div>';
            }
        }
        
        const modal = new bootstrap.Modal(document.getElementById('schemaModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading schema:', error);
        document.getElementById('schema-content').innerHTML = '<div class="alert alert-danger">Error loading schema</div>';
    }
}

function copySchema(evt) {
    const schemaText = document.getElementById('schema-json').textContent;
    copyToClipboard(evt, schemaText, '<i class="fas fa-check"></i> Copied!');
}

function copyToClipboard(evt, text, successHtml = '<i class="fas fa-check"></i>') {
    const button = evt?.target?.closest('button');

    const showFeedback = () => {
        if (!button) {
            return;
        }
        const originalContent = button.innerHTML;
        button.innerHTML = successHtml;
        setTimeout(() => {
            button.innerHTML = originalContent;
        }, 2000);
    };

    if (!navigator.clipboard) {
        fallbackCopy(text);
        showFeedback();
        return;
    }

    navigator.clipboard.writeText(text).then(() => {
        showFeedback();
    }).catch(err => {
        console.error('Failed to copy text:', err);
        fallbackCopy(text);
        showFeedback();
    });
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.setAttribute('readonly', '');
    textArea.style.position = 'absolute';
    textArea.style.left = '-9999px';
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
}

async function saveAgentId(flowId) {
    try {
        const agentIdInput = document.getElementById(`agent-${flowId}`);
        const agentId = agentIdInput.value.trim();
        
        const response = await fetch(`/api/flows/${flowId}/agent`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ agent_identifier: agentId })
        });
        
        if (response.ok) {
            // Show success feedback
            const button = agentIdInput.nextElementSibling;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.className = 'btn btn-success btn-sm';
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.className = 'btn btn-outline-success btn-sm';
            }, 2000);
        } else {
            alert('Failed to save agent identifier');
        }
    } catch (error) {
        console.error('Error saving agent identifier:', error);
        alert('Error saving agent identifier');
    }
}

async function viewDetails(flowId) {
    try {
        const response = await fetch(`/api/flows?per_page=1000`);
        const data = await response.json();
        const flow = data.flows.find(f => f.id === flowId);
        
        if (flow) {
            const detailsContent = document.getElementById('details-content');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><th>UID:</th><td>${flow.uid}</td></tr>
                            <tr><th>Summary:</th><td>${flow.summary || 'N/A'}</td></tr>
                            <tr><th>Author:</th><td>${flow.author || 'N/A'}</td></tr>
                            <tr><th>Method:</th><td>${flow.method || 'N/A'}</td></tr>
                            <tr><th>Organization:</th><td>${flow.organization || 'N/A'}</td></tr>
                            <tr><th>Status:</th><td>${flow.deprecated ? 'Deprecated' : 'Active'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Technical Details</h6>
                        <table class="table table-sm">
                            <tr><th>Source:</th><td><small>${flow.source || 'N/A'}</small></td></tr>
                            <tr><th>URL:</th><td><small>${flow.url || 'N/A'}</small></td></tr>
                            <tr><th>Created:</th><td>${flow.created_at ? new Date(flow.created_at).toLocaleString() : 'N/A'}</td></tr>
                            <tr><th>Updated:</th><td>${flow.updated_at ? new Date(flow.updated_at).toLocaleString() : 'N/A'}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>Description</h6>
                        <p>${flow.description || 'No description available'}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>Tags</h6>
                        <div>
                            ${flow.tags ? flow.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : 'No tags'}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>MIP-003 API URLs</h6>
                        <div class="api-urls">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label small">Base URL (by UID):</label>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="text" class="form-control font-monospace" value="http://localhost:8000/${flow.uid}" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(event, 'http://localhost:8000/${flow.uid}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Base URL (URL-friendly):</label>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="text" class="form-control font-monospace" value="http://localhost:8000/${flow.url_identifier || flow.summary}" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(event, 'http://localhost:8000/${flow.url_identifier || flow.summary}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label small">Available endpoints:</label>
                                    <ul class="list-unstyled small text-muted">
                                        <li><code>GET /{flow_identifier}/input_schema</code> - Get input schema</li>
                                        <li><code>POST /{flow_identifier}/start_job</code> - Start a new job</li>
                                        <li><code>GET /{flow_identifier}/status?job_id={job_id}</code> - Check job status</li>
                                        <li><code>GET /{flow_identifier}/availability</code> - Check availability</li>
                                        <li><code>POST /{flow_identifier}/provide_input</code> - Provide additional input</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }
        
    } catch (error) {
        console.error('Error loading details:', error);
    }
}

// Search on Enter key
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchFlows();
    }
});

// Load flows on page load
document.addEventListener('DOMContentLoaded', () => loadFlows());
</script>
{% endblock %}
